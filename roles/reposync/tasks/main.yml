---
- name: Include mirror configs
  include_vars: mirrors.yml

- name: Create run-parts dir
  file:
    path: /var/mirror.d
    state: directory
    mode: 0755

- name: Create sync dirs
  file:
    path: "/srv/mirror/{{ item.name }}"
    state: directory
    mode: 0755
  with_items: "{{ mirrors }}"

- name: Install sync scripts
  template:
    src: reposync.j2
    dest: "/var/mirror.d/{{ item.name | regex_replace('\/', '_') }}"
    mode: 0755
  with_items: "{{ mirrors }}"

# laxer-os repo
- name: Clone laxer-os source repo
  git:
    repo: 'https://github.com/Laxer-os/laxer-repo'
    dest: /srv/laxer

- name: Symlink laxer into webroot
  file:
    src: /srv/laxer/x86_64
    dest: /srv/mirror/laxer
    state: link

- name: Install laxer-os script
  copy:
    src: sync_laxer.sh
    dest: /var/mirror.d/sync_laxer.sh
    mode: 0755

# add run-parts cron
- name: Add mirror run-parts cron entry
  cron:
    name: "sync mirrors"
    hour: "*/4"
    job: run-parts /var/mirror.d

# xiph mirror
- name: Add xiph user
  user:
    name: xiph

- name: Create xiph sync dir
  file:
    path: /srv/mirror/xiph
    state: directory
    mode: 0755
    owner: xiph

- name: Set up rrsync script
  copy:
    src: /usr/share/doc/rsync/scripts/rrsync
    dest: /usr/local/bin/rrsync
    mode: 0755
    remote_src: yes

- name: Set up xiph ssh pubkey
  authorized_key:
    user: xiph
    state: present
    exclusive: True
    key: '{{ item }}'
    key_options: 'restrict,command="/usr/local/bin/rrsync /srv/mirror/xiph"'
  with_file:
    - xiph.pub

